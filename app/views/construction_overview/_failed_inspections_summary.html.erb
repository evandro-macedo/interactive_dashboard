<%
  # Calcular métricas agregadas do summary (Query 7)
  total_inspections = summary.sum { |s| s['total_inspections_reprovadas'].to_i }
  total_casas = summary.sum { |s| s['total_casas'].to_i }

  # Phase mais afetada (maior número de inspeções)
  most_affected_phase = summary.max_by { |s| s['total_inspections_reprovadas'].to_i }

  # Percentual médio (remover o símbolo % e calcular média)
  avg_percentage = if summary.any?
    percentages = summary.map { |s| s['percentual'].to_s.gsub('%', '').to_f }
    (percentages.sum / percentages.size).round(1)
  else
    0
  end
%>

<!-- Cards de Métricas-Chave -->
<div class="container-fluid p-0">
  <div class="row g-3 mb-4">
    <!-- Card 1: Total de Inspeções -->
    <div class="col-3">
    <div class="card border-left-danger shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col">
            <div class="text-xs font-weight-bold text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.05em;">
              Total Inspeções
            </div>
            <div class="h4 mb-0 font-weight-bold"><%= total_inspections %></div>
            <div class="text-muted mt-1" style="font-size: 0.8rem;">Reprovadas ativas</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-times-circle fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card 2: Phase Mais Afetada -->
  <div class="col-3">
    <div class="card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col">
            <div class="text-xs font-weight-bold text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.05em;">
              Phase Crítica
            </div>
            <div class="h4 mb-0 font-weight-bold">
              <%= most_affected_phase&.dig('phase_atual')&.gsub('Phase ', '') || '-' %>
            </div>
            <div class="text-muted mt-1" style="font-size: 0.8rem;">Maior número</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card 3: Casas Afetadas -->
  <div class="col-3">
    <div class="card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col">
            <div class="text-xs font-weight-bold text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.05em;">
              Casas Afetadas
            </div>
            <div class="h4 mb-0 font-weight-bold"><%= total_casas %></div>
            <div class="text-muted mt-1" style="font-size: 0.8rem;">Com inspeções</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-home fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Card 4: Percentual Médio -->
  <div class="col-3">
    <div class="card border-left-secondary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col">
            <div class="text-xs font-weight-bold text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 0.05em;">
              % Médio
            </div>
            <div class="h4 mb-0 font-weight-bold"><%= avg_percentage %>%</div>
            <div class="text-muted mt-1" style="font-size: 0.8rem;">Por phase</div>
          </div>
          <div class="col-auto">
            <i class="fas fa-percentage fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Gráfico de Barras -->
<div class="card shadow mb-0">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-danger" style="font-size: 0.95rem;">
      Distribuição por Phase
    </h6>
  </div>
  <div class="card-body p-2">
    <p class="text-muted mb-3" style="font-size: 0.875rem;">
      <i class="fas fa-mouse-pointer"></i> Clique em uma barra para filtrar
    </p>
    <div data-controller="failed-inspections"
         data-failed-inspections-summary-data-value="<%= summary.to_json %>"
         style="position: relative; height: 280px;">
      <canvas data-failed-inspections-target="canvas"></canvas>
    </div>
  </div>
</div>
