<!-- Page Heading -->
<div class="d-sm-flex align-items-center justify-content-between mb-4">
  <h1 class="h3 mb-0 text-gray-800">Daily Logs - Data Lake</h1>
  <a href="#" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm">
    <i class="fas fa-download fa-sm text-white-50"></i> Export Data
  </a>
</div>

<!-- Sync Status Info -->
<% if (last_sync = Dailylog.last_sync_info) %>
  <div class="alert <%= last_sync.successful? ? 'alert-info' : 'alert-warning' %> alert-dismissible fade show mb-3" role="alert">
    <i class="fas fa-sync-alt"></i>
    <% if last_sync.successful? %>
      <strong>Last updated:</strong> <%= time_ago_in_words(last_sync.synced_at) %> ago
      (<%= number_with_delimiter(last_sync.records_synced) %> records synced in <%= last_sync.duration_ms %>ms)
    <% else %>
      <strong>Sync failed:</strong> <%= time_ago_in_words(last_sync.synced_at) %> ago
      - <%= last_sync.error_message %>
    <% end %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% end %>

<!-- Real-time Search Form -->
<div class="card shadow mb-3">
  <div class="card-body">
    <%= form_with url: dailylogs_path, method: :get,
                  data: {
                    controller: "search",
                    turbo_frame: "dailylogs_table",
                    search_target: "form"
                  } do |f| %>
      <div class="row g-2">
        <!-- Column Selector -->
        <div class="col-md-3">
          <select name="column"
                  class="form-select"
                  data-action="change->search#search">
            <option value="all" <%= 'selected' if params[:column].blank? || params[:column] == 'all' %>>
              All Columns
            </option>

            <% Dailylog.grouped_searchable_columns.each do |group, columns| %>
              <% next if group.nil? %>
              <optgroup label="<%= group %>">
                <% columns.each do |key, config| %>
                  <option value="<%= key %>" <%= 'selected' if params[:column] == key %>>
                    <%= config[:label] %>
                  </option>
                <% end %>
              </optgroup>
            <% end %>
          </select>
        </div>

        <!-- Search Input -->
        <div class="col-md-7">
          <input type="text"
                 name="q"
                 value="<%= params[:q] %>"
                 class="form-control"
                 placeholder="Type to search..."
                 data-action="input->search#search"
                 autocomplete="off">
        </div>

        <!-- Buttons -->
        <div class="col-md-2">
          <div class="btn-group w-100">
            <button class="btn btn-primary" type="submit">
              <i class="fas fa-search"></i>
            </button>
            <% if params[:q].present? %>
              <%= link_to dailylogs_path, class: "btn btn-outline-secondary", title: "Clear search" do %>
                <i class="fas fa-times"></i>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Search hint -->
      <% if params[:q].present? && params[:column] && params[:column] != 'all' %>
        <small class="text-muted mt-2 d-block">
          Searching in: <strong><%= Dailylog::SEARCHABLE_COLUMNS.dig(params[:column], :label) %></strong>
        </small>
      <% end %>
    <% end %>
  </div>
</div>

<% if flash[:alert] %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= flash[:alert] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% end %>

<!-- âœ… Stable Wrapper Pattern (lessons-learned) -->
<div id="dailylogs_search_wrapper">
  <turbo-frame id="dailylogs_table">
    <%= render "table", dailylogs: @dailylogs %>
  </turbo-frame>
</div>
