<!-- Page Header with Modern Layout -->
<div class="page-header-wrapper">
  <div class="page-header-content">
    <h1 class="h3 mb-0">Daily Logs - Data Lake</h1>
    <p class="page-header-subtitle">
      <i class="bi bi-journal-text"></i>
      Comprehensive daily construction logs
    </p>
  </div>

  <div class="d-flex align-items-center gap-3">
    <!-- Simple Sync Status Badge -->
    <% if (last_sync = Dailylog.last_sync_info) %>
      <%
        minutes_ago = ((Time.current - last_sync.synced_at) / 60).to_i
        badge_class = if last_sync.failed?
                        'sync-badge-error'
                      elsif minutes_ago > 10
                        'sync-badge-warning'
                      else
                        'sync-badge-success'
                      end
        icon_class = last_sync.failed? ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill'
        formatted_total = (last_sync.records_synced >= 1000) ? "#{(last_sync.records_synced / 1000.0).round(1)}K" : last_sync.records_synced.to_s
        duration_s = (last_sync.duration_ms / 1000.0).round(1)
      %>
      <div class="sync-status-badge <%= badge_class %>">
        <i class="bi <%= icon_class %> me-2"></i>
        <span class="fw-semibold">Updated <%= time_ago_in_words(last_sync.synced_at) %> ago</span>
        <span class="mx-1 text-muted">•</span>
        <span><i class="bi bi-database me-1"></i><%= formatted_total %></span>
        <span class="mx-1 text-muted">•</span>
        <span><i class="bi bi-lightning-fill me-1"></i><%= duration_s %>s</span>
      </div>
    <% end %>

    <!-- Export Button -->
    <a href="#" class="btn btn-sm btn-primary shadow-sm">
      <i class="fas fa-download fa-sm text-white-50"></i> Export Data
    </a>
  </div>
</div>

<!-- Real-time Search Form -->
<div class="card shadow mb-3">
  <div class="card-body">
    <%= form_with url: dailylogs_path, method: :get,
                  data: {
                    controller: "search",
                    turbo_frame: "dailylogs_table",
                    search_target: "form"
                  } do |f| %>
      <div class="row g-2">
        <!-- Column Selector -->
        <div class="col-md-3">
          <select name="column"
                  class="form-select"
                  data-action="change->search#search">
            <option value="all" <%= 'selected' if params[:column].blank? || params[:column] == 'all' %>>
              All Columns
            </option>

            <% Dailylog.grouped_searchable_columns.each do |group, columns| %>
              <% next if group.nil? %>
              <optgroup label="<%= group %>">
                <% columns.each do |key, config| %>
                  <option value="<%= key %>" <%= 'selected' if params[:column] == key %>>
                    <%= config[:label] %>
                  </option>
                <% end %>
              </optgroup>
            <% end %>
          </select>
        </div>

        <!-- Search Input -->
        <div class="col-md-7">
          <input type="text"
                 name="q"
                 value="<%= params[:q] %>"
                 class="form-control"
                 placeholder="Type to search..."
                 data-action="input->search#search"
                 autocomplete="off">
        </div>

        <!-- Buttons -->
        <div class="col-md-2">
          <div class="btn-group w-100">
            <button class="btn btn-primary" type="submit">
              <i class="fas fa-search"></i>
            </button>
            <% if params[:q].present? %>
              <%= link_to dailylogs_path, class: "btn btn-outline-secondary", title: "Clear search" do %>
                <i class="fas fa-times"></i>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Search hint -->
      <% if params[:q].present? && params[:column] && params[:column] != 'all' %>
        <small class="text-muted mt-2 d-block">
          Searching in: <strong><%= Dailylog::SEARCHABLE_COLUMNS.dig(params[:column], :label) %></strong>
        </small>
      <% end %>
    <% end %>
  </div>
</div>

<% if flash[:alert] %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= flash[:alert] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% end %>

<!-- ✅ Stable Wrapper Pattern (lessons-learned) -->
<div id="dailylogs_search_wrapper" data-controller="table-scroll">
  <turbo-frame id="dailylogs_table">
    <%= render "table", dailylogs: @dailylogs %>
  </turbo-frame>
</div>

<!-- ==================== FMEA SECTION ==================== -->
<hr class="my-5">

<!-- Page Header with Modern Layout - FMEA -->
<div class="page-header-wrapper">
  <div class="page-header-content">
    <h1 class="h3 mb-0">FMEA Records - Data Lake</h1>
    <p class="page-header-subtitle">
      <i class="bi bi-exclamation-diamond"></i>
      Failure mode and effects analysis records
    </p>
  </div>

  <!-- Simple Sync Status Badge - FMEA -->
  <% if (fmea_sync = DailylogFmea.last_sync_info) %>
    <%
      minutes_ago = ((Time.current - fmea_sync.synced_at) / 60).to_i
      badge_class = if fmea_sync.failed?
                      'sync-badge-error'
                    elsif minutes_ago > 10
                      'sync-badge-warning'
                    else
                      'sync-badge-success'
                    end
      icon_class = fmea_sync.failed? ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill'
      formatted_total = (fmea_sync.records_synced >= 1000) ? "#{(fmea_sync.records_synced / 1000.0).round(1)}K" : fmea_sync.records_synced.to_s
      duration_s = (fmea_sync.duration_ms / 1000.0).round(1)
    %>
    <div class="sync-status-badge <%= badge_class %>">
      <i class="bi <%= icon_class %> me-2"></i>
      <span class="fw-semibold">Updated <%= time_ago_in_words(fmea_sync.synced_at) %> ago</span>
      <span class="mx-1 text-muted">•</span>
      <span><i class="bi bi-database me-1"></i><%= formatted_total %></span>
      <span class="mx-1 text-muted">•</span>
      <span><i class="bi bi-lightning-fill me-1"></i><%= duration_s %>s</span>
    </div>
  <% end %>
</div>

<!-- Real-time Search Form - FMEA -->
<div class="card shadow mb-3">
  <div class="card-body">
    <%= form_with url: dailylogs_path, method: :get,
                  data: {
                    controller: "search",
                    turbo_frame: "dailylogs_fmea_table",
                    search_target: "form"
                  } do |f| %>
      <div class="row g-2">
        <!-- Column Selector -->
        <div class="col-md-3">
          <select name="fmea_column"
                  class="form-select"
                  data-action="change->search#search">
            <option value="all" <%= 'selected' if params[:fmea_column].blank? || params[:fmea_column] == 'all' %>>
              All Columns
            </option>

            <% DailylogFmea.grouped_searchable_columns.each do |group, columns| %>
              <% next if group.nil? %>
              <optgroup label="<%= group %>">
                <% columns.each do |key, config| %>
                  <option value="<%= key %>" <%= 'selected' if params[:fmea_column] == key %>>
                    <%= config[:label] %>
                  </option>
                <% end %>
              </optgroup>
            <% end %>
          </select>
        </div>

        <!-- Search Input -->
        <div class="col-md-7">
          <input type="text"
                 name="fmea_q"
                 value="<%= params[:fmea_q] %>"
                 class="form-control"
                 placeholder="Search FMEA records..."
                 data-action="input->search#search"
                 autocomplete="off">
        </div>

        <!-- Buttons -->
        <div class="col-md-2">
          <div class="btn-group w-100">
            <button class="btn btn-primary" type="submit">
              <i class="fas fa-search"></i>
            </button>
            <% if params[:fmea_q].present? %>
              <%= link_to dailylogs_path, class: "btn btn-outline-secondary", title: "Clear search" do %>
                <i class="fas fa-times"></i>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Search hint -->
      <% if params[:fmea_q].present? && params[:fmea_column] && params[:fmea_column] != 'all' %>
        <small class="text-muted mt-2 d-block">
          Searching in: <strong><%= DailylogFmea::SEARCHABLE_COLUMNS.dig(params[:fmea_column], :label) %></strong>
        </small>
      <% end %>
    <% end %>
  </div>
</div>

<!-- FMEA Table Wrapper -->
<div id="dailylogs_fmea_wrapper" data-controller="table-scroll">
  <turbo-frame id="dailylogs_fmea_table">
    <%= render "table_fmea", dailylogs_fmea: @dailylogs_fmea %>
  </turbo-frame>
</div>
