<!-- Page Header with Modern Layout -->
<div class="page-header-wrapper">
  <div class="page-header-content">
    <h1 class="h3 mb-0">Daily Logs - Data Lake</h1>
    <p class="page-header-subtitle">
      <i class="bi bi-journal-text"></i>
      Comprehensive daily construction logs
    </p>
  </div>

  <div class="d-flex align-items-center gap-3">
    <!-- Simple Sync Status Badge -->
    <% if (last_sync = Dailylog.last_sync_info) %>
      <%
        minutes_ago = ((Time.current - last_sync.synced_at) / 60).to_i
        badge_class = if last_sync.failed?
                        'sync-badge-error'
                      elsif minutes_ago > 10
                        'sync-badge-warning'
                      else
                        'sync-badge-success'
                      end
        icon_class = last_sync.failed? ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill'
        formatted_total = (last_sync.records_synced >= 1000) ? "#{(last_sync.records_synced / 1000.0).round(1)}K" : last_sync.records_synced.to_s
        duration_s = (last_sync.duration_ms / 1000.0).round(1)
      %>
      <div class="sync-status-badge <%= badge_class %>">
        <i class="bi <%= icon_class %> me-2"></i>
        <span class="fw-semibold">Updated <%= time_ago_in_words(last_sync.synced_at) %> ago</span>
        <span class="mx-1 text-muted">•</span>
        <span><i class="bi bi-database me-1"></i><%= formatted_total %></span>
        <span class="mx-1 text-muted">•</span>
        <span><i class="bi bi-lightning-fill me-1"></i><%= duration_s %>s</span>
      </div>
    <% end %>

    <!-- Export Button -->
    <a href="#" class="btn btn-sm btn-primary shadow-sm">
      <i class="fas fa-download fa-sm text-white-50"></i> Export Data
    </a>
  </div>
</div>

<!-- Multi-Filter Form -->
<div class="card shadow mb-3" data-controller="multi-filter" data-multi-filter-table-value="dailylogs">
  <div class="card-body">
    <!-- Add Filter Form -->
    <%= form_with url: dailylogs_path, method: :get,
                  data: {
                    turbo_frame: "dailylogs_table",
                    multi_filter_target: "form"
                  } do |f| %>

      <!-- Preserve existing filters as hidden fields -->
      <% @active_filters.each do |column, value| %>
        <%= hidden_field_tag "filters[#{column}]", value %>
      <% end %>

      <div class="row g-2">
        <!-- Column Selector -->
        <div class="col-md-3">
          <select data-multi-filter-target="columnSelect"
                  class="form-select">
            <option value="">+ Add Filter...</option>

            <% Dailylog.grouped_searchable_columns.each do |group, columns| %>
              <% next if group.nil? %>
              <optgroup label="<%= group %>">
                <% columns.each do |key, config| %>
                  <% next if @active_filters.key?(key) %> <!-- Skip already filtered columns -->
                  <option value="<%= key %>">
                    <%= config[:label] %>
                  </option>
                <% end %>
              </optgroup>
            <% end %>
          </select>
        </div>

        <!-- Filter Value Input -->
        <div class="col-md-7">
          <input type="text"
                 data-multi-filter-target="valueInput"
                 class="form-control"
                 placeholder="Enter filter value..."
                 autocomplete="off">
        </div>

        <!-- Add Button -->
        <div class="col-md-2">
          <button type="button"
                  data-action="click->multi-filter#addFilter"
                  class="btn btn-primary w-100">
            <i class="fas fa-plus"></i> Add
          </button>
        </div>
      </div>
    <% end %>

    <!-- Legacy single search fallback (for users typing directly) -->
    <% if params[:q].present? && @active_filters.blank? %>
      <div class="alert alert-info mt-3 mb-0">
        <i class="fas fa-info-circle"></i>
        Searching for "<strong><%= params[:q] %></strong>"
        <% if params[:column].present? && params[:column] != 'all' %>
          in <strong><%= Dailylog::SEARCHABLE_COLUMNS.dig(params[:column], :label) %></strong>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<% if flash[:alert] %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= flash[:alert] %>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
<% end %>

<!-- ✅ Stable Wrapper Pattern (lessons-learned) -->
<div id="dailylogs_search_wrapper" data-controller="table-scroll">
  <turbo-frame id="dailylogs_table">
    <%= render "filters_and_table",
               dailylogs: @dailylogs,
               active_filters: @active_filters,
               offset: @offset,
               per_page: @per_page,
               has_more: @has_more %>
  </turbo-frame>
</div>

<!-- ==================== FMEA SECTION ==================== -->
<hr class="my-5">

<!-- Page Header with Modern Layout - FMEA -->
<div class="page-header-wrapper">
  <div class="page-header-content">
    <h1 class="h3 mb-0">FMEA Records - Data Lake</h1>
    <p class="page-header-subtitle">
      <i class="bi bi-exclamation-diamond"></i>
      Failure mode and effects analysis records
    </p>
  </div>

  <!-- Simple Sync Status Badge - FMEA -->
  <% if (fmea_sync = DailylogFmea.last_sync_info) %>
    <%
      minutes_ago = ((Time.current - fmea_sync.synced_at) / 60).to_i
      badge_class = if fmea_sync.failed?
                      'sync-badge-error'
                    elsif minutes_ago > 10
                      'sync-badge-warning'
                    else
                      'sync-badge-success'
                    end
      icon_class = fmea_sync.failed? ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill'
      formatted_total = (fmea_sync.records_synced >= 1000) ? "#{(fmea_sync.records_synced / 1000.0).round(1)}K" : fmea_sync.records_synced.to_s
      duration_s = (fmea_sync.duration_ms / 1000.0).round(1)
    %>
    <div class="sync-status-badge <%= badge_class %>">
      <i class="bi <%= icon_class %> me-2"></i>
      <span class="fw-semibold">Updated <%= time_ago_in_words(fmea_sync.synced_at) %> ago</span>
      <span class="mx-1 text-muted">•</span>
      <span><i class="bi bi-database me-1"></i><%= formatted_total %></span>
      <span class="mx-1 text-muted">•</span>
      <span><i class="bi bi-lightning-fill me-1"></i><%= duration_s %>s</span>
    </div>
  <% end %>
</div>

<!-- Multi-Filter Form - FMEA -->
<div class="card shadow mb-3" data-controller="multi-filter" data-multi-filter-table-value="fmea">
  <div class="card-body">
    <!-- Add Filter Form -->
    <%= form_with url: dailylogs_path, method: :get,
                  data: {
                    turbo_frame: "dailylogs_fmea_table",
                    multi_filter_target: "form"
                  } do |f| %>

      <!-- Preserve existing filters as hidden fields -->
      <% @active_fmea_filters.each do |column, value| %>
        <%= hidden_field_tag "fmea_filters[#{column}]", value %>
      <% end %>

      <div class="row g-2">
        <!-- Column Selector -->
        <div class="col-md-3">
          <select data-multi-filter-target="columnSelect"
                  class="form-select">
            <option value="">+ Add Filter...</option>

            <% DailylogFmea.grouped_searchable_columns.each do |group, columns| %>
              <% next if group.nil? %>
              <optgroup label="<%= group %>">
                <% columns.each do |key, config| %>
                  <% next if @active_fmea_filters.key?(key) %> <!-- Skip already filtered columns -->
                  <option value="<%= key %>">
                    <%= config[:label] %>
                  </option>
                <% end %>
              </optgroup>
            <% end %>
          </select>
        </div>

        <!-- Filter Value Input -->
        <div class="col-md-7">
          <input type="text"
                 data-multi-filter-target="valueInput"
                 class="form-control"
                 placeholder="Enter filter value..."
                 autocomplete="off">
        </div>

        <!-- Add Button -->
        <div class="col-md-2">
          <button type="button"
                  data-action="click->multi-filter#addFilter"
                  class="btn btn-primary w-100">
            <i class="fas fa-plus"></i> Add
          </button>
        </div>
      </div>
    <% end %>

    <!-- Legacy single search fallback -->
    <% if params[:fmea_q].present? && @active_fmea_filters.blank? %>
      <div class="alert alert-info mt-3 mb-0">
        <i class="fas fa-info-circle"></i>
        Searching for "<strong><%= params[:fmea_q] %></strong>"
        <% if params[:fmea_column].present? && params[:fmea_column] != 'all' %>
          in <strong><%= DailylogFmea::SEARCHABLE_COLUMNS.dig(params[:fmea_column], :label) %></strong>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- FMEA Table Wrapper -->
<div id="dailylogs_fmea_wrapper" data-controller="table-scroll">
  <turbo-frame id="dailylogs_fmea_table">
    <%= render "filters_and_table_fmea",
               dailylogs_fmea: @dailylogs_fmea,
               active_fmea_filters: @active_fmea_filters,
               fmea_offset: @fmea_offset,
               per_page: @per_page,
               has_more_fmea: @has_more_fmea %>
  </turbo-frame>
</div>
