# Especifica√ß√µes T√©cnicas - Queries de Pend√™ncias por Phase

**Data Cria√ß√£o:** 2025-10-23
**√öltima Atualiza√ß√£o:** 2025-10-23
**Vers√£o:** 3.1 (em desenvolvimento)
**Status:** Aguardando Upgrade RDS

---

## üìä Vis√£o Geral do Projeto

### Objetivo
Criar queries SQL para identificar problemas/pend√™ncias em casas ativas, organizadas por phase, para dashboard no Google Looker Studio com refresh a cada 5 minutos.

### Escopo
- **6 queries novas** (Queries 7-12): 3 categorias √ó 2 n√≠veis (resumo + detalhado)
- **Integra√ß√£o** com queries existentes (1-6)
- **Performance alvo:** < 25 segundos por query
- **Compatibilidade:** Google Looker Studio (snake_case, sem Unicode)

---

## üóÇÔ∏è Estrutura das Queries

### Queries Existentes (v3.0)
| Query | Descri√ß√£o | Performance Atual |
|-------|-----------|-------------------|
| Query 1 | Resumo de casas por phase | 174ms ‚úÖ |
| Query 2 | Lista detalhada por phase | ~800ms ‚úÖ |
| Query 3 | Total de casas ativas | ~300ms ‚úÖ |
| Query 4 | Jobs finalizados | ~200ms ‚úÖ |
| Query 5 | Lista individual (Looker) | ~800ms ‚úÖ |
| Query 6 | Hist√≥rico por casa | 0.5ms (mat view) ‚úÖ |

### Queries Novas (v3.1)
| Query | Categoria | Tipo | Performance Atual | Meta |
|-------|-----------|------|-------------------|------|
| Query 7 | Inspe√ß√µes Reprovadas | Resumo | 88s ‚ö†Ô∏è | < 25s |
| Query 8 | Inspe√ß√µes Reprovadas | Detalhado | N√£o testada | < 30s |
| Query 9 | Reports Pendentes | Resumo | N√£o testada | < 20s |
| Query 10 | Reports Pendentes | Detalhado | N√£o testada | < 25s |
| Query 11 | Scheduled Aberto | Resumo | N√£o testada | < 20s |
| Query 12 | Scheduled Aberto | Detalhado | N√£o testada | < 30s |

---

## üîç Especifica√ß√µes Detalhadas por Query

### Query 7: Inspe√ß√µes Reprovadas - Resumo

**Prop√≥sito:** Contar quantas casas t√™m inspe√ß√µes reprovadas ativas por phase

**L√≥gica de Neg√≥cio:**
- Filtrar processos com `process LIKE '%inspection%'`
- Status = `'inspection disapproved'`
- Excluir se existe `'inspection approved'` mais recente para o mesmo job+process
- Agrupar por phase atual da casa

**Colunas Retornadas:**
```sql
phase_atual              -- Phase 0, Phase 1, etc.
total_casas              -- Contagem distinct de job_id
total_inspections_reprovadas  -- Contagem total (pode ser > total_casas)
percentual               -- Percentual sobre total de casas ativas
```

**Performance:**
- **Atual:** 88 segundos (RDS 1GB, sem √≠ndices)
- **Meta:** < 25 segundos
- **Resultado Teste:** 24 casas com inspe√ß√µes reprovadas (Phase 2: 5, Phase 3: 11, Phase 4: 8)

**√çndices Necess√°rios:**
- `idx_dailylogs_process_pattern` - Para LIKE '%inspection%'
- `idx_dailylogs_status` - Para filtro de status
- `idx_dailylogs_job_process_date` - Para JOIN job+process

---

### Query 8: Inspe√ß√µes Reprovadas - Detalhado

**Prop√≥sito:** Listar cada inspe√ß√£o reprovada ativa com detalhes

**Colunas Retornadas:**
```sql
phase_atual              -- Phase da casa
job_id                   -- ID da casa
jobsite                  -- Nome da casa
processo_inspecao        -- Nome do processo de inspe√ß√£o
data_reprovacao          -- Quando foi reprovada
dias_em_aberto          -- Dias desde a reprova√ß√£o
ultimo_status           -- √öltimo status do processo
data_ultimo_status      -- Data do √∫ltimo status
```

**Ordena√ß√£o:** Por phase, depois por dias_em_aberto DESC (mais antigas primeiro)

**Performance Meta:** < 30 segundos

---

### Query 9: Reports sem Checklist Done - Resumo

**Prop√≥sito:** Contar quantas casas t√™m reports pendentes por phase

**L√≥gica de Neg√≥cio:**
- Filtrar registros com `status = 'report'`
- Excluir se existe `status = 'checklist done'` cronologicamente posterior
- Agrupar por phase

**Colunas Retornadas:**
```sql
phase_atual              -- Phase da casa
total_casas              -- Contagem distinct de job_id
total_reports_pendentes  -- Contagem total de reports
percentual               -- Percentual sobre total ativo
```

**Performance Meta:** < 20 segundos

---

### Query 10: Reports sem Checklist Done - Detalhado

**Prop√≥sito:** Listar cada report pendente com regras de neg√≥cio complexas

**L√≥gica de Neg√≥cio (REGRAS FMEA):**

**REGRA 0: Exclus√£o por FMEA not_report**
```sql
-- Excluir se processo+status est√° marcado como not_report na tabela FMEA
WHERE NOT EXISTS (
  SELECT 1 FROM dailylogs_fmea
  WHERE process = prd.process
    AND status = prd.status
    AND not_report = TRUE
)
```

**REGRA 1: Rework Scheduled Posterior**
```sql
-- Excluir se existe 'rework scheduled' AP√ìS o report
WHERE NOT EXISTS (
  SELECT 1 FROM dailylogs
  WHERE job_id = prd.job_id
    AND process = prd.process
    AND status = 'rework scheduled'
    AND datecreated > prd.report_date
)
```

**REGRA 2: Checklist Done com FMEA**
```sql
-- Excluir se existe 'checklist done' com FMEA AP√ìS o report
WHERE NOT EXISTS (
  SELECT 1 FROM dailylogs_fmea
  WHERE job_id = prd.job_id
    AND process = prd.process
    AND status = 'checklist done'
    AND failure_group ILIKE '%fmea%'
    AND datecreated::timestamp > prd.report_date
)
```

**REGRA 3: Rework Requested com FMEA**
```sql
-- Excluir se existe 'rework requested' com FMEA AP√ìS o report
WHERE NOT EXISTS (
  SELECT 1 FROM dailylogs_fmea
  WHERE job_id = prd.job_id
    AND process = prd.process
    AND status = 'rework requested'
    AND failure_group ILIKE '%fmea%'
    AND datecreated::timestamp > prd.report_date
)
```

**REGRA 4: In Progress Posterior**
```sql
-- Excluir se existe 'in progress' AP√ìS o report
WHERE NOT EXISTS (
  SELECT 1 FROM dailylogs
  WHERE job_id = prd.job_id
    AND process = prd.process
    AND status = 'in progress'
    AND datecreated > prd.report_date
)
```

**Colunas Retornadas:**
```sql
phase_atual              -- Phase da casa
job_id                   -- ID da casa
jobsite                  -- Nome da casa
processo                 -- Nome do processo
data_report              -- Data do report
dias_pendente           -- Dias desde o report
tem_checklist_done_anterior  -- Boolean (teve checklist antes?)
```

**Tabelas Utilizadas:**
- `dailylogs` - Tabela principal
- `dailylogs_fmea` - Tabela de FMEA (Failure Mode and Effects Analysis)

**Performance Meta:** < 25 segundos

**Complexidade:** ALTA (5 subqueries NOT EXISTS)

---

### Query 11: Scheduled sem Checklist Done - Resumo

**Prop√≥sito:** Contar quantos processos scheduled est√£o abertos por phase

**L√≥gica de Neg√≥cio:**
- Filtrar registros com `status = 'scheduled'`
- Verificar se N√ÉO existe `status = 'checklist done'` para o mesmo job+process
- Agrupar por phase

**Colunas Retornadas:**
```sql
phase_atual              -- Phase da casa
total_casas              -- Contagem distinct de job_id
total_items_scheduled_abertos  -- Contagem de items
percentual               -- Percentual sobre total ativo
```

**Performance Meta:** < 20 segundos

---

### Query 12: Scheduled sem Checklist Done - Detalhado

**Prop√≥sito:** Listar cada scheduled aberto com status atual do item

**L√≥gica de Neg√≥cio:**
- Buscar processos com `status = 'scheduled'` sem `'checklist done'`
- Retornar o √∫ltimo status AP√ìS o scheduled (status atual do item)

**Colunas Retornadas:**
```sql
phase_atual              -- Phase da casa
job_id                   -- ID da casa
jobsite                  -- Nome da casa
processo                 -- Nome do processo
data_scheduled          -- Quando foi scheduled
status_atual_do_item    -- √öltimo status ap√≥s scheduled
data_ultimo_status      -- Data do √∫ltimo status
dias_em_aberto          -- Dias desde scheduled
```

**Ordena√ß√£o:** Por phase, depois por dias_em_aberto DESC

**Performance Meta:** < 30 segundos

---

## üèóÔ∏è Infraestrutura

### RDS Atual (db.t3.micro)
```
RAM: 1 GB
vCPUs: 2
Storage: [verificar]
Custo: ~$15/m√™s
Status: NO LIMITE ‚ö†Ô∏è
```

### RDS Planejado (db.t3.small)
```
RAM: 2 GB (DOBRO)
vCPUs: 2
Storage: [manter]
Custo: ~$30/m√™s (+$15)
Status: UPGRADE AGENDADO ‚úÖ
```

### √çndices Existentes
```sql
idx_dailylogs_optimized       -- (datecreated, job_id)
idx_dailylogs_job_id          -- (job_id)
idx_dailylogs_process         -- (process)
idx_dailylogs_datecreated     -- (datecreated DESC) [v3.0]
idx_dailylogs_status          -- (status) [v3.0 - j√° existe]
```

### √çndices a Criar (P√≥s-Upgrade)
```sql
-- 1. Para pattern matching em process
idx_dailylogs_process_pattern
  ON dailylogs(process text_pattern_ops)
  Impacto: Queries 7-8
  Tamanho: ~5-8 MB

-- 2. Para filtros de phase
idx_dailylogs_phase
  ON dailylogs(phase)
  Impacto: Todas as queries
  Tamanho: ~2-3 MB

-- 3. Para JOINs complexos
idx_dailylogs_job_process_date
  ON dailylogs(job_id, process, datecreated DESC)
  Impacto: Queries 7-12 (todas)
  Tamanho: ~10-15 MB

-- 4. Para √∫ltimo status
idx_dailylogs_job_status_date
  ON dailylogs(job_id, status, datecreated DESC)
  Impacto: Queries com DISTINCT ON
  Tamanho: ~10-12 MB

-- 5. Para inspe√ß√µes
idx_dailylogs_process_status
  ON dailylogs(process, status)
  Impacto: Queries 7-8
  Tamanho: ~5-7 MB

Total Adicional: ~35-50 MB
```

---

## üìã Plano de A√ß√£o

### FASE 1: Upgrade RDS ‚úÖ AGENDADO
**Respons√°vel:** Usu√°rio
**Prazo:** Em andamento
**Dura√ß√£o:** 5-10 minutos (downtime)

**Checklist:**
- [x] Upgrade solicitado via AWS Console
- [ ] Aguardar conclus√£o
- [ ] Verificar status: `db.t3.small`
- [ ] Avisar Claude quando completo

---

### FASE 2: Cria√ß√£o de √çndices ‚è≥ AGUARDANDO
**Respons√°vel:** Claude
**Pr√©-requisito:** Upgrade RDS completo
**Dura√ß√£o:** 15-20 minutos
**Arquivo:** `/firefighting/optimization_indexes.sql`

**Comando de Execu√ß√£o:**
```bash
export PGPASSWORD='[senha]'
psql -h lakeshoredevelopmentfl.ch88as8s0tio.us-east-2.rds.amazonaws.com \
     -U postgres_admin \
     -d postgres \
     -f optimization_indexes.sql
```

**Checklist:**
- [ ] Executar cria√ß√£o de √≠ndices
- [ ] Monitorar progresso (via CloudWatch)
- [ ] Verificar √≠ndices criados
- [ ] Executar ANALYZE dailylogs

---

### FASE 3: Testes de Performance ‚è≥ AGUARDANDO
**Respons√°vel:** Claude
**Pr√©-requisito:** √çndices criados
**Dura√ß√£o:** 30-40 minutos

**Testes Planejados:**

1. **Query 7 - Benchmark**
   - Executar com EXPLAIN ANALYZE
   - Comparar: 88s ‚Üí ? (meta: <25s)
   - Documentar plano de execu√ß√£o

2. **Queries 8-12 - Primeira Execu√ß√£o**
   - Executar cada query
   - Medir tempo
   - Validar resultados

3. **Valida√ß√£o de Consist√™ncia**
   - Query 7 (resumo) vs Query 8 (detalhe): total_casas deve bater
   - Query 9 (resumo) vs Query 10 (detalhe): total_casas deve bater
   - Query 11 (resumo) vs Query 12 (detalhe): total_casas deve bater

4. **Regression Test**
   - Queries 1-6 n√£o devem ter piorado
   - Performance mantida ou melhorada

**Checklist:**
- [ ] Testar Query 7 com EXPLAIN ANALYZE
- [ ] Testar Queries 8-12 individualmente
- [ ] Validar consist√™ncia resumo vs detalhe
- [ ] Verificar regression nas queries antigas
- [ ] Documentar todos os tempos

---

### FASE 4: Documenta√ß√£o Final ‚è≥ AGUARDANDO
**Respons√°vel:** Claude
**Pr√©-requisito:** Testes completos

**Atualiza√ß√µes Necess√°rias:**

1. **`01_queries.sql`**
   - Atualizar cabe√ßalho para v3.1
   - Documentar tempos reais nas queries 7-12
   - Adicionar notas de performance

2. **`02_estrategia.md`** (opcional)
   - Documentar estrat√©gia das queries de pend√™ncias
   - Explicar regras FMEA da Query 10

3. **`03_regras_de_negocio.md`** (opcional)
   - Adicionar regras 0-4 da Query 10
   - Documentar tabela dailylogs_fmea

4. **`ESPECIFICACOES_TECNICAS.md`** (este arquivo)
   - Atualizar com resultados finais
   - Marcar FASE 2-4 como completas

**Checklist:**
- [ ] Atualizar changelog em 01_queries.sql
- [ ] Atualizar tempos de performance
- [ ] Documentar regras FMEA
- [ ] Marcar projeto como completo

---

## üéØ M√©tricas de Sucesso

### Performance Target

| M√©trica | Valor Alvo | Como Medir |
|---------|------------|------------|
| **Query 7** | < 25s | EXPLAIN ANALYZE |
| **Query 8** | < 30s | EXPLAIN ANALYZE |
| **Query 9** | < 20s | EXPLAIN ANALYZE |
| **Query 10** | < 25s | EXPLAIN ANALYZE |
| **Query 11** | < 20s | EXPLAIN ANALYZE |
| **Query 12** | < 30s | EXPLAIN ANALYZE |
| **M√©dia Geral** | < 25s | M√©dia das 6 queries |
| **Todas < 30s?** | SIM | Looker timeout compliance |

### Viabilidade Looker Studio

**Requisitos:**
- ‚úÖ Refresh a cada 5 minutos
- ‚úÖ Timeout: 30 segundos por query
- ‚úÖ Cache habilitado (5 min)

**C√°lculo de Carga:**
```
12 queries antigas + 6 queries novas = 18 queries total
18 queries √ó 25s m√©dia = 450s (7.5 min)

COM CACHE (5 min):
- Looker executa 1x a cada 5 min
- Usu√°rios veem dados cacheados
- ‚úÖ VI√ÅVEL
```

---

## üìä Complexidade das Queries

### An√°lise de Complexidade

| Query | CTEs | JOINs | Subqueries | LIKE | NOT EXISTS | Complexidade |
|-------|------|-------|------------|------|------------|--------------|
| Q7 | 5 | 1 | 1 | 2 | 0 | M√âDIA |
| Q8 | 6 | 3 | 1 | 2 | 0 | M√âDIA-ALTA |
| Q9 | 5 | 1 | 1 | 0 | 0 | M√âDIA |
| Q10 | 5 | 3 | 1 | 0 | 5 | ALTA ‚ö†Ô∏è |
| Q11 | 5 | 1 | 1 | 0 | 0 | M√âDIA |
| Q12 | 7 | 3 | 1 | 0 | 0 | M√âDIA-ALTA |

**Query 10 √© a mais complexa:**
- 5 CTEs aninhadas
- 3 JOINs
- **5 NOT EXISTS** (subqueries correlacionadas)
- Usa tabela `dailylogs_fmea` adicional
- Maior risco de performance ruim

---

## üóÑÔ∏è Schema de Dados

### Tabela: dailylogs (principal)
```sql
Colunas relevantes:
- job_id (integer) - PK composta
- process (text) - Nome do processo
- status (text) - Status do processo
- phase (text) - Phase 0-4
- datecreated (timestamp) - Data do registro
- jobsite (text) - Nome da casa
- addedby (text) - Usu√°rio
- sub (text) - Subcontratada
- servicedate (text) - Data de servi√ßo
- notes (text) - Observa√ß√µes

Tamanho: ~185K registros
```

### Tabela: dailylogs_fmea (FMEA)
```sql
Colunas relevantes:
- job_id (integer)
- process (text)
- status (text)
- failure_group (text) - Grupo de falha (ex: 'fmea')
- datecreated (timestamp)
- not_report (boolean) - Marcador de exclus√£o

Tamanho: [desconhecido]
Uso: Query 10 (regras de neg√≥cio FMEA)
```

---

## üö® Riscos e Mitiga√ß√µes

### Risco 1: Performance Insuficiente
**Probabilidade:** M√âDIA
**Impacto:** ALTO

**Se queries ainda estiverem > 30s ap√≥s √≠ndices:**
- ‚úÖ Otimizar CTEs (combinar, simplificar)
- ‚úÖ Usar MATERIALIZED views (com Lambda refresh)
- ‚úÖ Cache mais agressivo no Looker (10-15 min)
- ‚úÖ Avaliar upgrade adicional (db.t3.medium - 4GB)

### Risco 2: Query 10 Muito Lenta
**Probabilidade:** ALTA ‚ö†Ô∏è
**Impacto:** M√âDIO

**Devido a:**
- 5 NOT EXISTS (subqueries correlacionadas)
- JOIN com tabela dailylogs_fmea adicional

**Mitiga√ß√µes:**
- ‚úÖ Criar √≠ndice em dailylogs_fmea (job_id, process, status)
- ‚úÖ Reescrever NOT EXISTS como LEFT JOIN ... WHERE IS NULL
- ‚úÖ Simplificar l√≥gica se poss√≠vel

### Risco 3: Tabela FMEA Inexistente
**Probabilidade:** BAIXA
**Impacto:** CR√çTICO

**Se dailylogs_fmea n√£o existir:**
- Query 10 falhar√° com erro
- Verificar exist√™ncia antes de deploy

**Comando de Verifica√ß√£o:**
```sql
SELECT EXISTS (
  SELECT 1 FROM information_schema.tables
  WHERE table_name = 'dailylogs_fmea'
);
```

---

## üìû Comunica√ß√£o

### Status Atual
**√öltima Atualiza√ß√£o:** 2025-10-23
**Status:** Aguardando Upgrade RDS

### Pr√≥ximos Marcos
1. ‚úÖ Upgrade RDS completo ‚Üí Avisar Claude
2. ‚è≥ √çndices criados ‚Üí Claude avisa
3. ‚è≥ Testes completos ‚Üí Claude avisa
4. ‚è≥ Documenta√ß√£o final ‚Üí Claude avisa

---

## üìÅ Arquivos do Projeto

```
/firefighting/
‚îú‚îÄ‚îÄ 01_queries.sql                  # Queries 1-12 (v3.1)
‚îú‚îÄ‚îÄ 02_estrategia.md               # Estrat√©gia das queries
‚îú‚îÄ‚îÄ 03_regras_de_negocio.md        # Regras de neg√≥cio
‚îú‚îÄ‚îÄ optimization_indexes.sql        # Script de √≠ndices
‚îî‚îÄ‚îÄ ESPECIFICACOES_TECNICAS.md     # Este arquivo
```

---

**Documento Mantido Por:** Claude Code
**Pr√≥xima Revis√£o:** Ap√≥s conclus√£o FASE 4
